<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>sp-service - 1.0.0-SNAPSHOT</title>
    <script src="/js/rest-client.js"></script>
    <script>
        window.onload = function () {
            var api = new RestClient('http://localhost:8080/api/v1');
            api.res('token');

            // test we're ok
            findAllTokens(api).then((tokens) => {
               document.write("<font color='green'><b> We are ok. Tokens found: " + tokens.length + "</b></font><br/>");
               var table = document.createElement("table");
               table.setAttribute("border", "1");
               setTableHeader(Object.keys(tokens[0]), table)
               setTableData(tokens, table);
               document.body.appendChild(table);
            });
        };

        const setTableHeader = function(fields, table) {
            console.log(fields);
            const thead = document.createElement("thead");
            thead.id = 'tableThead';
            const tr = document.createElement("tr");
            const fragment = document.createDocumentFragment();
            fields.forEach(x => {
                const th = document.createElement("th");
                th.innerText = x;
                th.scope = "col";
                fragment.appendChild(th);
            });
            tr.appendChild(fragment);
            thead.appendChild(tr);
            table.appendChild(thead);
        };

        const setTableData = function(tokens, table) {
            //console.log(fields);
            const tbody = document.createElement("tbody");
            tbody.id = 'tableTbody';
            tokens.forEach(x => {
                const tr = document.createElement("tr");
                const fragment = document.createDocumentFragment();
                const keys = Object.keys(tokens[0])
                keys.forEach(key => {
                    td = document.createElement("td");
                    td.innerText = x[key];
                    fragment.appendChild(td);
                });
                tr.appendChild(fragment);
                tbody.appendChild(tr);
                table.appendChild(tbody);
            })
        };


        findAllTokens = async function (api) {
            const token_definitions = await api.token().get();
            const token_promises = token_definitions.map(async (token_def) => {
                return api.token(token_def.name).get();
            });
            return await Promise.all(token_promises);
        };

        deleteToken = async function (api, token_name) {
            return api.token(token_name).delete();
        };

        getToken = async function (api, token_name) {
            return api.token(token_name).get();
        };

        createToken = async function (api, token) {
            return api.token(token_name).post(token);
        };

        updateToken = async function (api, token) {
            return api.token(token.name).put(token);
        };
    </script>
</head>
<body>
</body>
</html>